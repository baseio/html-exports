<!DOCTYPE html><html lang="en"><head><title>documentloader</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="documentloader"><meta name="groc-project-path" content="src/documentloader.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/documentloader.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="htmlexportsdocumentloader">HTMLExports.DocumentLoader</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper">;(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(scope)</span> {</span>
<span class="hljs-pi">  'use strict'</span>

  scope.DocumentLoader = DocumentLoader</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO(nevir)</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DocumentLoader</span><span class="hljs-params">(options, parentHooks)</span> {</span>
    Reflect.Loader.call(<span class="hljs-keyword">this</span>, options || {})
    <span class="hljs-keyword">this</span>._parentHooks = parentHooks || Reflect.Loader.prototype
  }
  DocumentLoader.prototype = <span class="hljs-built_in">Object</span>.create(Reflect.Loader.prototype)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="-documentloader-mixin-"><code>DocumentLoader.mixin</code></h3></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Rather than instantiating and managing a <code>DocumentLoader</code> directly, you
will frequently want to mix <code>DocumentLoader</code>&#39;s behavior into an existing
instance of <code>Reflect.Loader</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> MIXIN_HOOKS = [<span class="hljs-string">'instantiate'</span>]</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The hooks defined on the loader instance will be overridden, and chained
when operating on a resource that <code>DocumentLoader</code> doesn&#39;t understand.
For example, to override the default system loader:</p>
<pre><code class="lang-js">HTMLExports.DocumentLoader.mixin(System)</code></pre></div></div><div class="code"><div class="wrapper">  DocumentLoader.mixin = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mixin</span><span class="hljs-params">(loader)</span> {</span>
    console.debug(<span class="hljs-string">'DocumentLoader.mixin('</span>, loader, <span class="hljs-string">')'</span>)
    <span class="hljs-keyword">var</span> parentHooks = {}
    <span class="hljs-keyword">var</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>({}, parentHooks)
    MIXIN_HOOKS.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(hook)</span> {</span>
      parentHooks[hook] = loader[hook].bind(loader)
      loader[hook] = instance[hook].bind(instance)
    })</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the author is using es6-module-loader, make sure to set up <code>.html</code>
URLs so that they are not overridden.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (loader.paths) {
      loader.paths[<span class="hljs-string">'*.html'</span>] = <span class="hljs-string">'*.html'</span>
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>And if the author is using System.js, we have to shim the original
System too...</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (loader.originalSystem) {
      DocumentLoader.mixin(loader.originalSystem)
    }
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="loader-hooks">Loader Hooks</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="-documentloader-instantiate-"><code>DocumentLoader#instantiate</code></h3></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO(nevir)</p></div></div><div class="code"><div class="wrapper">  DocumentLoader.prototype.instantiate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">instantiate</span><span class="hljs-params">(load)</span> {</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._isHtml(load)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._parentHooks.instantiate.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>)
    }
    console.debug(<span class="hljs-string">'DocumentLoader#instantiate('</span>, load, <span class="hljs-string">')'</span>)

    <span class="hljs-keyword">var</span> doc = <span class="hljs-keyword">this</span>._newDocument(load)
    <span class="hljs-keyword">return</span> {
      deps: scope.depsFor(doc),
      execute: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.newModule(scope.exportsFor(doc))
      }.bind(<span class="hljs-keyword">this</span>),
    }
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Internal Implementation</p></div></div><div class="code"><div class="wrapper">  DocumentLoader.prototype._isHtml = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_isHtml</span><span class="hljs-params">(load)</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A <code>.html</code> extension is a good hint.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> path = load.address || load.name
    <span class="hljs-keyword">if</span> (path &amp;&amp; path.slice(-<span class="hljs-number">5</span>) === <span class="hljs-string">'.html'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Otherwise, we check the content for something that looks like HTML:</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (load.source &amp;&amp; load.source.match &amp;&amp; load.source.match(<span class="hljs-regexp">/^\s*&lt;/</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>While I&#39;d prefer to make use of HTML Imports, System.js (rightfully) makes
many assumptions about load record&#39;s <code>source</code> being a string. So, we just
consume that.
This mostly follows the HTML Imports polyfill:
<a href="https://github.com/Polymer/HTMLImports/blob/master/src/importer.js#L121-147">https://github.com/Polymer/HTMLImports/blob/master/src/importer.js#L121-147</a></p></div></div><div class="code"><div class="wrapper">  DocumentLoader.prototype._newDocument = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_newDocument</span><span class="hljs-params">(load)</span> {</span>
    <span class="hljs-keyword">var</span> doc = document.implementation.createHTMLDocument(<span class="hljs-string">'module: '</span> + load.name)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO(nevir): do we need to build a base URL from this?</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> base = doc.createElement(<span class="hljs-string">'base'</span>)
    base.setAttribute(<span class="hljs-string">'href'</span>, load.address)
    <span class="hljs-keyword">if</span> (!doc.baseURI) {
      doc.baseURI = load.address
    }
    doc.head.appendChild(base)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Imports/module enforce UTF-8</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> meta = doc.createElement(<span class="hljs-string">'meta'</span>)
    meta.setAttribute(<span class="hljs-string">'charset'</span>, <span class="hljs-string">'utf-8'</span>)
    doc.head.appendChild(meta)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Actually import the resource.</p></div></div><div class="code"><div class="wrapper">    doc.body.innerHTML = load.source</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Template polyfill support.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (window.HTMLTemplateElement &amp;&amp; HTMLTemplateElement.bootstrap) {
      HTMLTemplateElement.bootstrap(doc)
    }

    <span class="hljs-keyword">return</span> doc
  }

})(<span class="hljs-keyword">this</span>.HTMLExports = <span class="hljs-keyword">this</span>.HTMLExports || {})</div></div></div></div></body></html>